# Keycloakè‡ªå®šä¹‰è®¤è¯æ¨¡å— (Custom Authenticator)
## ğŸ“–é¡¹ç›®ç®€ä»‹
æœ¬é¡¹ç›®custom-authæ˜¯ä¸€ä¸ªåŸºäºKeycloakå¹³å°å¼€å‘çš„è‡ªå®šä¹‰è®¤è¯å™¨ã€‚æ ¸å¿ƒæ˜¯Keycloakæä¾›çš„æ ‡å‡†èº«ä»½éªŒè¯æµç¨‹å¢åŠ ä¸€å±‚é¢å¤–çš„å®‰å…¨æ ¡éªŒæœºåˆ¶ï¼Œå³åŸºäºç§»åŠ¨ç»ˆç«¯è®¾å¤‡å±æ€§çš„å‡­è¯è®¤è¯ï¼Œæ»¡è¶³è·¨ä¸»ä½“æ•°æ®é‰´æƒç³»ç»Ÿçš„å®‰å…¨è¦æ±‚ã€‚æœ¬æ¨¡å—åœ¨Keycloakè®¤è¯æµä¸­å……å½“åè°ƒè€…ï¼Œå°†è®¤è¯å†³ç­–è½¬äº¤ç»™å¤–éƒ¨çš„Credential-ServeræœåŠ¡ã€‚
#### æ ¸å¿ƒè®¤è¯æµç¨‹
**è§¦å‘**: Keycloak è®¤è¯æµåœ¨è¿è¡Œæ—¶è°ƒç”¨æœ¬æ¨¡å—ã€‚  
**æ•°æ®äº¤äº’**: æœ¬æ¨¡å—è´Ÿè´£ä¸å¤–éƒ¨Credential-Serveré€šä¿¡ï¼Œè·å–æ¯”å¯¹ç»“æœã€‚  
**å†³ç­–**: è‹¥è®¾å¤‡å‡­è¯æ¯”å¯¹æˆåŠŸï¼Œç”¨æˆ·ç›´æ¥é€šè¿‡è®¾å¤‡è®¤è¯ï¼›è‹¥å¤±è´¥ï¼Œè®¤è¯æµç¨‹å°†å¯¼å‘ä¼ ç»Ÿçš„è´¦å·å¯†ç ç™»å½•ç•Œé¢ã€‚
## ğŸ—ï¸ç¯å¢ƒä¾èµ–ä¸Keycloakå®ä¾‹æ„å»º
### ç¯å¢ƒä¾èµ–
æœ¬é¡¹ç›®ä¾èµ–äº Keycloak 24.0.5 ç‰ˆæœ¬çš„æºç è¿›è¡Œç¼–è¯‘å’Œéƒ¨ç½²ã€‚éœ€ä» https://github.com/keycloak/keycloak/releases/tag/24.0.5 ä¸‹è½½ Source code (zip)ã€‚æœ¬åœ°æ„å»ºå®ä¾‹ç”Ÿæˆ keycloak-999.0.0-SNAPSHOTã€‚æ¨èä½¿ç”¨ JDK 17 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚
### å¼€å‘å®ä¾‹æ„å»ºæ­¥éª¤
è¦è¿è¡Œæœ¬é¡¹ç›®ï¼Œè¦å…ˆå®Œæˆ Keycloak æœåŠ¡å™¨çš„æ„å»ºå’Œå¯åŠ¨ï¼š  
Â· **æºç æ„å»º**: ä¸‹è½½ Keycloak 24.0.5 æºç ï¼Œå¹¶åœ¨æœ¬åœ°å®Œæˆæ„å»ºï¼Œå°†ç”Ÿæˆ keycloak-999.0.0-SNAPSHOT ç‰ˆæœ¬çš„æœåŠ¡å™¨å‘è¡ŒåŒ…ã€‚  
Â· **å¯åŠ¨æœåŠ¡å™¨**: è¿›å…¥æœ¬åœ°æ„å»ºçš„ Keycloak æœåŠ¡å™¨ bin ç›®å½•ï¼ˆä¾‹å¦‚ï¼šD:\keycloak\keycloak-main\keycloak-999.0.0-SNAPSHOT\binï¼‰ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå³å¯å¯åŠ¨å¼€å‘æ¨¡å¼æœåŠ¡å™¨ï¼š
```bash
kc.bat start-dev --hostname=localhost
```
## ğŸ¨è‡ªå®šä¹‰è®¤è¯æ¨¡å—çš„éƒ¨ç½²&é…ç½®
### ç¬¬ä¸€é˜¶æ®µï¼šè‡ªå®šä¹‰æ¨¡å—ç¼–è¯‘ä¸éƒ¨ç½²
**ç¼–è¯‘æ¨¡å—:**   
å¯¼èˆªè‡³è®¤è¯æ¨¡å—custom-authenticatoræ ¹ç›®å½•ï¼Œæ‰§è¡Œ Maven ç¼–è¯‘å’Œæ‰“åŒ…å‘½ä»¤ï¼Œç”Ÿæˆ JAR åŒ…ï¼š
```bash
mvn clean install
mvn clean compile
mvn clean package
```
ç”Ÿæˆçš„jaråŒ…å°†å­˜å‚¨åœ¨custom-authenticator\targetç›®å½•ä¸‹ã€‚  
å°†jaråŒ…å¤åˆ¶åˆ°keycloak-999.0.0-SNAPSHOT\providers\æ–‡ä»¶å¤¹ä¸‹ä¹‹åï¼Œåœ¨keycloak-999.0.0-SNAPSHOT\binç›®å½•ä¸‹è¿è¡Œï¼š
```bash
kc.bat build  //è¯†åˆ«æ–°åŠ å…¥çš„Provider
kc.bat start-dev --hostname=localhost  //å¯åŠ¨æœåŠ¡å™¨
```
**éƒ¨ç½²éªŒè¯:**  
JAR åŒ…å®‰è£…æˆåŠŸåï¼Œä¼šè¢« Keycloak æœåŠ¡å™¨è‡ªåŠ¨åŠ è½½ã€‚æ­¤æ—¶å¯ä»¥è®¿é—®åå°ï¼ˆç™»å½•è´¦å·ï¼šadminï¼Œå¯†ç ï¼šadminï¼‰
```bash
http://localhost:8080/admin
```
### ç¬¬äºŒé˜¶æ®µï¼šKeycloak ç®¡ç†æ§åˆ¶å°é…ç½®
âŒå¦‚æœæ˜¯**åˆæ¬¡æ„å»º**ï¼Œåˆ™éœ€è¦å®Œæˆä»¥ä¸‹è‡ªå®šä¹‰é…ç½®ï¼š  
**é…ç½®é¢†åŸŸ(Realm)**: åˆ›å»ºæˆ–é€‰æ‹©ç›®æ ‡é¢†åŸŸã€‚  
**åˆ›å»ºæ–°çš„è®¤è¯æµï¼ˆAuthentication Flowï¼‰**: å¯¼èˆªè‡³ Authentication -> Flows é€‰é¡¹å¡ï¼Œåˆ›å»ºä¸€ä¸ªæ–°æµï¼ˆä¾‹å¦‚å‘½åä¸º My Authentication Flowï¼‰ã€‚  
**æ·»åŠ è‡ªå®šä¹‰æ‰§è¡Œå™¨ï¼ˆAuthenticatorï¼‰**: åœ¨æ–°æµä¸­ï¼Œæ·»åŠ è®¤è¯æ‰§è¡Œå™¨ï¼ˆä¾‹å¦‚å‘½åä¸º My Custom Authenticatorï¼‰ã€‚  
**ç»‘å®šè®¤è¯æµ**: å°† Browser Flowï¼ˆæˆ–ç›¸åº”çš„å®¢æˆ·ç«¯è®¤è¯æµç¨‹ï¼‰è®¾ç½®ä¸ºåˆšåˆ›å»ºçš„ My Authentication Flowã€‚  

âœ…å¦‚æœ**å·²åˆ›å»ºè¿‡**è‡ªå®šä¹‰é¢†åŸŸï¼Œåˆ™æ‰§è¡Œä»¥ä¸‹æ“ä½œå¯¼å…¥é¢†åŸŸï¼š  
Â· åœ¨å·¦ä¾§å¯¼èˆªæ ï¼Œç‚¹å‡» Add realmã€‚  
Â· é€‰æ‹© Importï¼Œä¸Šä¼  realm-export.json æ–‡ä»¶ï¼ˆåœ¨configæ–‡ä»¶å¤¹ä¸‹ï¼‰ã€‚  
è¿™ä¼šè‡ªåŠ¨åˆ›å»ºåŒ…å«è‡ªå®šä¹‰è®¤è¯æµå’Œæ‰€éœ€å®¢æˆ·ç«¯çš„é¢†åŸŸã€‚

### ç¬¬ä¸‰é˜¶æ®µï¼šç•Œé¢æ˜¾ç¤ºä¸è‡ªå®šä¹‰ä¸»é¢˜
è‡ªå®šä¹‰ä¸»é¢˜æ–‡ä»¶ä½äºä»“åº“çš„ /themes/mycustomtheme ç›®å½•ä¸‹ã€‚åœ¨å®Œæˆ Keycloak è®¤è¯æ¨¡å—çš„éƒ¨ç½²åï¼Œéœ€è¦æ‰§è¡Œä»¥ä¸‹æ“ä½œä»¥åº”ç”¨è‡ªå®šä¹‰ç•Œé¢ï¼š  
Â· **å¤åˆ¶ä¸»é¢˜æ–‡ä»¶ï¼š** å°†é¡¹ç›® Git ä»“åº“ä¸­çš„ /themes/ ç›®å½•å®Œæ•´å¤åˆ¶åˆ°æœ¬åœ° Keycloak æœåŠ¡å™¨çš„å®‰è£…ç›®å½•ä¸‹ï¼Œç¡®ä¿å­˜åœ¨ keycloak-999.0.0-SNAPSHOT\themes\mycustomtheme æ–‡ä»¶å¤¹ã€‚  
Â· **åœ¨æ§åˆ¶å°å¯ç”¨ï¼š**
ç™»å½• Keycloak ç®¡ç†ç•Œé¢ã€‚  
å¯¼èˆªè‡³ Realm Settings -> Themes é€‰é¡¹å¡ã€‚  
åœ¨ Login Themeï¼ˆç™»å½•ä¸»é¢˜ï¼‰ä¸‹æ‹‰èœå•ä¸­ï¼Œç¡®ä¿é€‰æ‹© mycustomthemeã€‚

## ğŸš¨è§¦å‘è‡ªå®šä¹‰è®¤è¯
```bash
http://localhost:8080/realms/myrealm/protocol/openid-connect/auth?client_id=test-app&redirect_uri=http://localhost&response_type=code&scope=openid
```
è´¦å·testuserï¼Œå¯†ç 123456å·²æ³¨å†Œï¼Œå¯è®¤è¯æˆåŠŸï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªé¡µé¢ï¼ˆä¸ç¨³å®šï¼Œæœ‰æ—¶å€™æ˜¾ç¤ºé”™è¯¯ï¼‰ï¼Œåç»­é¡µé¢è¿˜æ²¡å¼€å‘ã€‚
